<div class="reset-container">
  <div class="header-section">
    <h2>🔑 Recuperar Contraseña</h2>

    <!-- Indicador de pasos -->
    <div class="step-indicator">
      <div class="step-dot" [class.active]="step === 1" [class.completed]="step > 1"></div>
      <div class="step-dot" [class.active]="step === 2" [class.completed]="step > 2"></div>
      <div class="step-dot" [class.active]="step === 3" [class.completed]="step > 3"></div>
      <div class="step-dot" [class.active]="step === 4"></div>
    </div>
  </div>

  <!-- Mensaje global -->
  <div *ngIf="message"
       class="message"
       [class.success]="message.includes('✅') || message.includes('📧') || message.includes('🎉')"
       [class.error]="message.includes('❌') || message.includes('Error')"
       [class.info]="!message.includes('✅') && !message.includes('❌') && !message.includes('Error') && !message.includes('🎉')">
    {{ message }}
  </div>

  <!-- Paso 1: Solicitar reset -->
  <div *ngIf="step === 1" class="step-container">
    <div class="step-title">
      Ingresa tu correo electrónico para recibir el código de verificación
    </div>
    <form [formGroup]="emailForm" (ngSubmit)="requestReset()">
      <div class="form-group">
        <label>Correo electrónico</label>
        <div class="input-wrapper">
          <input formControlName="email"
                 type="email"
                 placeholder="ejemplo@correo.com"
                 autocomplete="email"
                 (input)="onEmailInput()" />
          <span class="input-icon">📧</span>
        </div>
        <div *ngIf="emailErrors" class="error-message">
          <span class="error-icon">⚠</span>
          {{ emailErrors }}
        </div>
      </div>
      <button type="submit"
              class="primary-button"
              [disabled]="loading || emailForm.invalid"
              [class.loading]="loading">
        <span *ngIf="!loading">Enviar código</span>
        <span *ngIf="loading" class="loading-spinner"></span>
      </button>
    </form>
  </div>

  <!-- Paso 2: Verificar código -->
  <div *ngIf="step === 2" class="step-container">
    <div class="step-title">
      Revisa tu correo e ingresa el código de 6 dígitos
    </div>

    <form [formGroup]="codeForm" (ngSubmit)="verifyCode()">
      <div class="form-group">
        <label for="otp-0">Código de verificación</label>

        <!-- Cajas OTP -->
        <div class="otp-grid" role="group" aria-label="Código de verificación de 6 dígitos">
          <input *ngFor="let i of otpIdx"
                 class="otp-box"
                 [id]="'otp-' + i"
                 type="text"
                 inputmode="numeric"
                 pattern="[0-9]*"
                 maxlength="1"
                 [formControlName]="i.toString()"
                 (input)="onOtpInput(i, $event)"
                 (keydown)="onOtpKeydown(i, $event)"
                 (paste)="onOtpPaste($event)"/>
        </div>

        <div *ngIf="codeErrors" class="error-message">
          <span class="error-icon">⚠️</span>
          {{ codeErrors }}
        </div>
      </div>

      <button type="submit"
              class="primary-button"
              [disabled]="loading || codeForm.invalid"
              [class.loading]="loading">
        <span *ngIf="!loading">Verificar código</span>
        <span *ngIf="loading" class="loading-spinner"></span>
      </button>

      <div class="button-group">
        <button type="button" class="secondary-button" (click)="step = 1">← Cambiar correo</button>
        <button type="button" class="secondary-button" (click)="resendCode()" [disabled]="loading">🔄 Reenviar código</button>
      </div>
    </form>
  </div>

  <!-- Paso 3: Resetear contraseña (con ojito ver/ocultar) -->
  <div *ngIf="step === 3" class="step-container">
    <div class="step-title">
      <span class="step-icon">🔒</span>
      Crea tu nueva contraseña segura
    </div>
    <form [formGroup]="resetForm" (ngSubmit)="resetPassword()">
      <!-- Nueva contraseña -->
      <div class="form-group">
        <label>Nueva contraseña</label>
        <div class="input-wrapper">
          <input formControlName="newPassword"
                 [type]="showNew ?  'password': 'text'"
                 placeholder="Mínimo 15 caracteres"
                 (input)="onPasswordInput()" />
          <span class="input-icon">🔒</span>

          <!-- OJITO SVG -->
          <button type="button"
                  class="toggle-eye"
                  [attr.aria-label]="showNew ? 'Ocultar contraseña' : 'Mostrar contraseña'"
                  (click)="showNew = !showNew">
            <svg *ngIf="!showNew" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M1.5 12s3.5-7 10.5-7 10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor" stroke-width="1.8" />
              <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.8"/>
            </svg>
            <svg *ngIf="showNew" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M1.5 12s3.5-7 10.5-7 10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor" stroke-width="1.8"/>
              <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.8"/>
              <path d="M4 20 20 4" stroke="currentColor" stroke-width="1.8" />
            </svg>
          </button>
        </div>
        <div *ngIf="passwordErrors" class="error-message">
          <span class="error-icon">⚠</span>
          {{ passwordErrors }}
        </div>
      </div>

      <!-- Confirmar contraseña -->
      <div class="form-group">
        <label>Confirmar contraseña</label>
        <div class="input-wrapper">
          <input formControlName="confirmPassword"
                 [type]="showConfirm ?  'password': 'text'"
                 placeholder="Repite tu contraseña" />
          <span class="input-icon">🔐</span>

          <!-- OJITO SVG -->
          <button type="button"
                  class="toggle-eye"
                  [attr.aria-label]="showConfirm ? 'Mostrar contraseña' : 'Ocultar contraseña'"
                  (click)="showConfirm = !showConfirm">
            <svg *ngIf="!showConfirm" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M1.5 12s3.5-7 10.5-7 10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor" stroke-width="1.8" />
              <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.8"/>
            </svg>
            <svg *ngIf="showConfirm" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M1.5 12s3.5-7 10.5-7 10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor" stroke-width="1.8"/>
              <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.8"/>
              <path d="M4 20 20 4" stroke="currentColor" stroke-width="1.8" />
            </svg>
          </button>
        </div>
        <div *ngIf="confirmPasswordErrors" class="error-message">
          <span class="error-icon">⚠</span>
          {{ confirmPasswordErrors }}
        </div>
      </div>

      <button type="submit"
              class="primary-button"
              [disabled]="loading || resetForm.invalid"
              [class.loading]="loading">
        <span *ngIf="!loading">Cambiar contraseña</span>
        <span *ngIf="loading" class="loading-spinner"></span>
      </button>
      <button type="button" class="secondary-button" (click)="step = 2">
        ← Volver al código
      </button>
    </form>
  </div>

  <!-- Paso 4: Éxito -->
  <div *ngIf="step === 4" class="final-step">
    <div class="success-animation">
      <div class="success-icon">🎉</div>
      <div class="success-circle"></div>
    </div>
    <p class="success-title">¡Contraseña restablecida!</p>
    <p class="success-subtitle">Ya puedes iniciar sesión con tu nueva contraseña</p>
    <div class="success-actions">
      <a routerLink="/login" class="success-button">
        <span>Iniciar sesión</span>
        <span class="button-arrow">→</span>
      </a>
      <button type="button" class="secondary-button" (click)="resetFlow()">
        🔄 Resetear otro usuario
      </button>
    </div>
  </div>
</div>
