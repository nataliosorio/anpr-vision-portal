<div class="reset-container">
  <div class="header-section">
    <h2>ğŸ”‘ Recuperar ContraseÃ±a</h2>

    <!-- Indicador de pasos -->
    <div class="step-indicator">
      <div class="step-dot" [class.active]="step === 1" [class.completed]="step > 1"></div>
      <div class="step-dot" [class.active]="step === 2" [class.completed]="step > 2"></div>
      <div class="step-dot" [class.active]="step === 3" [class.completed]="step > 3"></div>
      <div class="step-dot" [class.active]="step === 4"></div>
    </div>
  </div>

  <!-- Mensaje global -->
  <div *ngIf="message"
       class="message"
       [class.success]="message.includes('âœ…') || message.includes('ğŸ“§') || message.includes('ğŸ‰')"
       [class.error]="message.includes('âŒ') || message.includes('Error')"
       [class.info]="!message.includes('âœ…') && !message.includes('âŒ') && !message.includes('Error') && !message.includes('ğŸ‰')">
    {{ message }}
  </div>

  <!-- Paso 1: Solicitar reset -->
  <div *ngIf="step === 1" class="step-container">
    <div class="step-title">
      Ingresa tu correo electrÃ³nico para recibir el cÃ³digo de verificaciÃ³n
    </div>
    <form [formGroup]="emailForm" (ngSubmit)="requestReset()">
      <div class="form-group">
        <label>Correo electrÃ³nico</label>
        <div class="input-wrapper">
          <input formControlName="email"
                 type="email"
                 placeholder="ejemplo@correo.com"
                 autocomplete="email"
                 (input)="onEmailInput()" />
          <span class="input-icon">ğŸ“§</span>
        </div>
        <div *ngIf="emailErrors" class="error-message">
          <span class="error-icon">âš </span>
          {{ emailErrors }}
        </div>
      </div>
      <button type="submit"
              class="primary-button"
              [disabled]="loading || emailForm.invalid"
              [class.loading]="loading">
        <span *ngIf="!loading">Enviar cÃ³digo</span>
        <span *ngIf="loading" class="loading-spinner"></span>
      </button>
    </form>
  </div>

  <!-- Paso 2: Verificar cÃ³digo -->
  <div *ngIf="step === 2" class="step-container">
    <div class="step-title">
      Revisa tu correo e ingresa el cÃ³digo de 6 dÃ­gitos
    </div>

    <form [formGroup]="codeForm" (ngSubmit)="verifyCode()">
      <div class="form-group">
        <label for="otp-0">CÃ³digo de verificaciÃ³n</label>

        <!-- Cajas OTP -->
        <div class="otp-grid" role="group" aria-label="CÃ³digo de verificaciÃ³n de 6 dÃ­gitos">
          <input *ngFor="let i of otpIdx"
                 class="otp-box"
                 [id]="'otp-' + i"
                 type="text"
                 inputmode="numeric"
                 pattern="[0-9]*"
                 maxlength="1"
                 [formControlName]="i.toString()"
                 (input)="onOtpInput(i, $event)"
                 (keydown)="onOtpKeydown(i, $event)"
                 (paste)="onOtpPaste($event)"/>
        </div>

        <div *ngIf="codeErrors" class="error-message">
          <span class="error-icon">âš ï¸</span>
          {{ codeErrors }}
        </div>
      </div>

      <button type="submit"
              class="primary-button"
              [disabled]="loading || codeForm.invalid"
              [class.loading]="loading">
        <span *ngIf="!loading">Verificar cÃ³digo</span>
        <span *ngIf="loading" class="loading-spinner"></span>
      </button>

      <div class="button-group">
        <button type="button" class="secondary-button" (click)="step = 1">â† Cambiar correo</button>
        <button type="button" class="secondary-button" (click)="resendCode()" [disabled]="loading">ğŸ”„ Reenviar cÃ³digo</button>
      </div>
    </form>
  </div>

  <!-- Paso 3: Resetear contraseÃ±a (con ojito ver/ocultar) -->
  <div *ngIf="step === 3" class="step-container">
    <div class="step-title">
      <span class="step-icon">ğŸ”’</span>
      Crea tu nueva contraseÃ±a segura
    </div>
    <form [formGroup]="resetForm" (ngSubmit)="resetPassword()">
      <!-- Nueva contraseÃ±a -->
      <div class="form-group">
        <label>Nueva contraseÃ±a</label>
        <div class="input-wrapper">
          <input formControlName="newPassword"
                 [type]="showNew ?  'password': 'text'"
                 placeholder="MÃ­nimo 15 caracteres"
                 (input)="onPasswordInput()" />
          <span class="input-icon">ğŸ”’</span>

          <!-- OJITO SVG -->
          <button type="button"
                  class="toggle-eye"
                  [attr.aria-label]="showNew ? 'Ocultar contraseÃ±a' : 'Mostrar contraseÃ±a'"
                  (click)="showNew = !showNew">
            <svg *ngIf="!showNew" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M1.5 12s3.5-7 10.5-7 10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor" stroke-width="1.8" />
              <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.8"/>
            </svg>
            <svg *ngIf="showNew" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M1.5 12s3.5-7 10.5-7 10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor" stroke-width="1.8"/>
              <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.8"/>
              <path d="M4 20 20 4" stroke="currentColor" stroke-width="1.8" />
            </svg>
          </button>
        </div>
        <div *ngIf="passwordErrors" class="error-message">
          <span class="error-icon">âš </span>
          {{ passwordErrors }}
        </div>
      </div>

      <!-- Confirmar contraseÃ±a -->
      <div class="form-group">
        <label>Confirmar contraseÃ±a</label>
        <div class="input-wrapper">
          <input formControlName="confirmPassword"
                 [type]="showConfirm ?  'password': 'text'"
                 placeholder="Repite tu contraseÃ±a" />
          <span class="input-icon">ğŸ”</span>

          <!-- OJITO SVG -->
          <button type="button"
                  class="toggle-eye"
                  [attr.aria-label]="showConfirm ? 'Mostrar contraseÃ±a' : 'Ocultar contraseÃ±a'"
                  (click)="showConfirm = !showConfirm">
            <svg *ngIf="!showConfirm" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M1.5 12s3.5-7 10.5-7 10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor" stroke-width="1.8" />
              <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.8"/>
            </svg>
            <svg *ngIf="showConfirm" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M1.5 12s3.5-7 10.5-7 10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor" stroke-width="1.8"/>
              <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.8"/>
              <path d="M4 20 20 4" stroke="currentColor" stroke-width="1.8" />
            </svg>
          </button>
        </div>
        <div *ngIf="confirmPasswordErrors" class="error-message">
          <span class="error-icon">âš </span>
          {{ confirmPasswordErrors }}
        </div>
      </div>

      <button type="submit"
              class="primary-button"
              [disabled]="loading || resetForm.invalid"
              [class.loading]="loading">
        <span *ngIf="!loading">Cambiar contraseÃ±a</span>
        <span *ngIf="loading" class="loading-spinner"></span>
      </button>
      <button type="button" class="secondary-button" (click)="step = 2">
        â† Volver al cÃ³digo
      </button>
    </form>
  </div>

  <!-- Paso 4: Ã‰xito -->
  <div *ngIf="step === 4" class="final-step">
    <div class="success-animation">
      <div class="success-icon">ğŸ‰</div>
      <div class="success-circle"></div>
    </div>
    <p class="success-title">Â¡ContraseÃ±a restablecida!</p>
    <p class="success-subtitle">Ya puedes iniciar sesiÃ³n con tu nueva contraseÃ±a</p>
    <div class="success-actions">
      <a routerLink="/login" class="success-button">
        <span>Iniciar sesiÃ³n</span>
        <span class="button-arrow">â†’</span>
      </a>
      <button type="button" class="secondary-button" (click)="resetFlow()">
        ğŸ”„ Resetear otro usuario
      </button>
    </div>
  </div>
</div>
